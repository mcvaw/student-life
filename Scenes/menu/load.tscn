[gd_scene load_steps=3 format=2]

[ext_resource path="res://Scenes/menu/button-load.tscn" type="PackedScene" id=1]

[sub_resource type="GDScript" id=1]
script/source = "extends Control

export (PackedScene) var loadbtn

# Основной вертикальный контейнер
onready var box : = $ScrollContainer/VBoxContainer
onready var glob : = $\"/root/global\"


# При нажатии на удаление сохраненной игры
func on_Del_Pressed(game_id : String) -> void:
	get_node(\"/root/fx\").btn_click()
	
	# Удалить контейнер с кнопками
	var nd : = get_node(\"ScrollContainer/VBoxContainer/\" + game_id + \"_btn\")
	nd.get_parent().remove_child(nd)
	
	# Удалить папку
	var dir : = Directory.new()
	var path_to_dir : = \"user://\" + game_id
	var state = dir.open(path_to_dir)
	assert(state == OK)
	
	# Пройтись по всем файлам
	state = dir.list_dir_begin(true)
	assert(state == OK)
	var cur : = dir.get_next()
	while cur != \"\":
		state = dir.remove(path_to_dir + \"/\" + cur)
		assert(state == OK)
		cur = dir.get_next()
	dir.list_dir_end()
	
	# Удалить папку
	state = dir.remove(path_to_dir)
	assert(state == OK)


func btn_load_scene(name : String, game_id : String) -> void:
	get_node(\"/root/fx\").btn_click()
	glob.loaded = game_id
	get_node(\"/root/scene_loader\").load_scene(\"res://Scenes/\" + name)


func _ready() -> void:
	# Открыть папку с сохранениями
	var dir = Directory.new()
	dir.open(\"user://\")
	dir.list_dir_begin(true, true)
	var dir_name : String = dir.get_next()
	# Для всех id сохраненных игр
	while dir_name != \"\":
		if dir_name != \"config.json\":
			# Загрузить шаблон кнопки
			var tmp = loadbtn.instance()
			tmp.name = dir_name + \"_btn\"
			box.add_child(tmp)
			var btn = get_node(\"ScrollContainer/VBoxContainer/\" + dir_name + \"_btn\")
			
			# Изменить название сохранения
			btn.set_game_name(\"#\" + dir_name)
			
			# Привязать кнопку удаления
			var state = btn.get_delete_btn().connect(
				\"pressed\", self, \"on_Del_Pressed\", [dir_name])
			assert(state == OK)
			
			# Прочитать stage из папки
			var stage = get_node(\"/root/prop\").get_param(dir_name, \"stage\")
			var properties : Dictionary = get_node(\"/root/events\").get_event_info(stage)
			btn.set_game_stage(properties[\"name\"])
			
			
			# Привязать кнопку к загрузке игры
			state = btn.get_load_btn().connect(
				\"pressed\", self,
				\"btn_load_scene\",
				[properties[\"scene\"], dir_name])
			assert(state == OK)
		dir_name = dir.get_next()
	dir.list_dir_end()
"

[node name="Control" type="Control"]
anchor_right = 1.0
anchor_bottom = 1.0
script = SubResource( 1 )
__meta__ = {
"_edit_use_anchors_": false
}
loadbtn = ExtResource( 1 )

[node name="ScrollContainer" type="ScrollContainer" parent="."]
anchor_right = 1.0
anchor_bottom = 1.0
scroll_horizontal_enabled = false
__meta__ = {
"_edit_use_anchors_": false
}

[node name="VBoxContainer" type="VBoxContainer" parent="ScrollContainer"]
margin_right = 1920.0
margin_bottom = 1080.0
size_flags_horizontal = 3
size_flags_vertical = 3
__meta__ = {
"_edit_use_anchors_": false
}
