[gd_scene load_steps=3 format=2]

[ext_resource path="res://Scenes/menu/button-load.tscn" type="PackedScene" id=1]

[sub_resource type="GDScript" id=1]
script/source = "extends Control

export (PackedScene) var loadbtn

# Основной вертикальный контейнер
onready var box : = $ScrollContainer/VBoxContainer
onready var glob : = $\"/root/global\"

# Возвращает словарь вида
# { 
#     \"i\" : {
#       \"name\"  : \"event name\", 
#       \"scene\" : \"path\"
#     }
# }

func get_event_names(list : Array) -> Dictionary:
	var dict : = {}
	var fl : = File.new()
	for i in list:
		fl.open(\"res://Events/\" + str(i) + \".tres\", File.READ)
		dict[str(i)] = parse_json(fl.get_line())
		fl.close()
	return dict

# При нажатии на удаление сохраненной игры
func on_Del_Pressed(num) -> void:
	get_node(\"/root/fx\").btn_click()
	# Удалить контейнер с кнопками
	var nd : = get_node(\"ScrollContainer/VBoxContainer/\" + str(num))
	nd.get_parent().remove_child(nd)
	# Удалить номер игры из массива
	var pos = glob.saved_games.bsearch(num)
	glob.saved_games.remove(pos)
	# Удалить сам файл
	var dir = Directory.new()
	dir.remove(\"user://save.\" + str(num) + \".txt\")

func btn_load_scene(name : String, num : int) -> void:
	get_node(\"/root/fx\").btn_click()
	glob.loaded = num
	get_tree().change_scene(\"res://Scenes/\" + name)

func _ready() -> void:
	if glob.saved_games.size() > 0:
		var list = []
		# Для всех номеров сохраненных игр
		for i in glob.saved_games:
			# Загрузить шаблон кнопки
			var tmp = loadbtn.instance()
			tmp.name = str(i)
			box.add_child(tmp)
			# Изменить название сохранения
			var loadpath : = \"ScrollContainer/VBoxContainer/\" + str(i) + \"/BtnLoad/ContLoad/TextGame\"
			get_node(loadpath).text = \"#\" + str(i)
			# Привязать кнопку удаления
			var delpath : = \"ScrollContainer/VBoxContainer/\" + str(i) + \"/BtnDel\"
			get_node(delpath).connect(\"pressed\", self, \"on_Del_Pressed\", [i])
	#		# Добавить stage из файла в список, 
	#		# чтобы потом найти описание этапа
			var fl : = File.new()
			fl.open(\"user://save.\" + str(i) + \".txt\", File.READ)
			var stage : = 0
			var content = parse_json(fl.get_line())
			if content != null:
				if content.has(\"stage\"):
					stage = content[\"stage\"]
			var stagepath : = \"ScrollContainer/VBoxContainer/\" + str(i) + \"/BtnLoad/ContLoad/TextStage\"
			get_node(stagepath).text = str(stage)
			if !list.has(int(stage)):
				list.push_back(int(stage))
			fl.close()
		# Присвоить этапы
		var dat = get_event_names(list)
		for i in glob.saved_games:
			var stagepath : = \"ScrollContainer/VBoxContainer/\" + str(i) + \"/BtnLoad/ContLoad/TextStage\"
			var tmp = dat[get_node(stagepath).text]
			get_node(stagepath).text = tmp[\"name\"]
			var btnpath : = \"ScrollContainer/VBoxContainer/\" + str(i) + \"/BtnLoad\"
			get_node(btnpath).connect(\"pressed\", self, \"btn_load_scene\", [tmp[\"scene\"], i])

"

[node name="Control" type="Control"]
anchor_right = 1.0
anchor_bottom = 1.0
script = SubResource( 1 )
__meta__ = {
"_edit_use_anchors_": false
}
loadbtn = ExtResource( 1 )

[node name="ScrollContainer" type="ScrollContainer" parent="."]
anchor_right = 1.0
anchor_bottom = 1.0
scroll_horizontal_enabled = false
__meta__ = {
"_edit_use_anchors_": false
}

[node name="VBoxContainer" type="VBoxContainer" parent="ScrollContainer"]
margin_right = 1920.0
margin_bottom = 1080.0
size_flags_horizontal = 3
size_flags_vertical = 3
__meta__ = {
"_edit_use_anchors_": false
}
